<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minhas Pontua√ß√µes - BomGesto</title>
  <link rel="stylesheet" href="stylesminhaspontuacoes.css">
</head>

<body>
<header class="hero">
  <div class="logo">
    <p>BomGesto</p>
    <img src="assets/icones/logobomgesto.png" alt="Logo" class="logo-img">
  </div>
  <nav class="nav-menu">
    <ul>
      <li><a href="sobre.html">Sobre</a></li>
      <li><a href="doacoes.html">Doa√ß√µes</a></li>
      <li><a href="pontuacao.html">Pontua√ß√µes</a></li>
      <li><a href="locais.html">Locais de doa√ß√£o</a></li>
      <li><a href="login.html" id="userName">Login</a></li>
    </ul>
  </nav>
</header>

<div class="container">
  <h1>Minha Pontua√ß√£o</h1>
  <p>Ol√°, <span id="nomeUsuario"></span>! Parab√©ns pelas suas contribui√ß√µes!</p>

  <div class="grid">
    <div>
      <div class="card">
        <p>üèÜ <b>Pontua√ß√£o:</b> <span id="pontuacao">0</span></p>
        <p>‚≠ê <b>N√≠vel:</b> <span id="nivel">-</span></p>
        <p>ü•á <b>Ranking:</b> <span id="ranking">-</span></p>
      </div>


      <p>üîé <a href="sobrepontuacao.html" class="btn">Ler mais sobre recompensas e n√≠veis</a></p>
    </div>

    <div class="card">
      <h3>Top Maiores Doadores üèÖ</h3>
      <ol id="topDoadores">
        <li>Carregando...</li>
      </ol>
    </div>
  </div>
</div>

<!-- Firebase e C√≥digo JS -->
<script type="module">
  // Importa√ß√µes do Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Configura√ß√£o do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBPAy9KdIk8e34yruaL32wyj_MJANHlN2g",
    authDomain: "bomgesto-15634.firebaseapp.com",
    projectId: "bomgesto-15634",
    storageBucket: "bomgesto-15634.appspot.com",
    messagingSenderId: "672802069001",
    appId: "1:672802069001:web:356d0b5ab9ae09d29236d8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const userName = document.getElementById("userName");

  // Autentica√ß√£o e carregamento dos dados
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const uid = user.uid;
      const docRef = doc(db, "usuarios", uid);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const nome = docSnap.data().nome;
        userName.textContent = nome;
        userName.href = "#";

        userName.addEventListener('click', async () => {
          await signOut(auth);
          window.location.reload();
        });

        await carregarDados(uid);
        await carregarTopDoadores();
        await carregarHistorico(uid);

      } else {
        console.log("Nenhum dado encontrado!");
      }
    } else {
      userName.textContent = "Login";
      userName.href = "login.html";
    }
  });

  // Carregar Dados do Usu√°rio
  async function carregarDados(uid) {
    const userRef = doc(db, "usuarios", uid);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
      const dados = userSnap.data();
      const pontos = dados.pontos || 0;

      document.getElementById("nomeUsuario").innerText = dados.nome || "Usu√°rio";
      document.getElementById("pontuacao").innerText = pontos;
      document.getElementById("nivel").innerText = definirNivel(pontos);
    }
  }

  function definirNivel(pontos) {
    if (pontos >= 100) return "üíé Lenda da Esperan√ßa";
    if (pontos >= 50) return "‚ù§Ô∏è Her√≥i da Comunidade";
    if (pontos >= 20) return "üíõ Aliado do Bem";
    return "üíô Iniciante Solid√°rio";
  }

  // Carregar Top Doadores
  async function carregarTopDoadores() {
    const q = query(collection(db, "usuarios"), orderBy("pontos", "desc"), limit(5));
    const querySnap = await getDocs(q);

    const lista = document.getElementById("topDoadores");
    lista.innerHTML = "";

    querySnap.forEach(docSnap => {
      const dados = docSnap.data();
      const li = document.createElement("li");
      li.textContent = `${dados.nome} - ${dados.pontos} pts`;
      lista.appendChild(li);
    });
  }

  // Carregar Hist√≥rico de Doa√ß√µes
  async function carregarHistorico(uid) {
    const q = query(
      collection(db, "doacoes"),
      where("userId", "==", uid), // üî• Important√≠ssimo ter userId na doa√ß√£o
      orderBy("dataRetirada", "desc")
    );

    const querySnap = await getDocs(q);
    const lista = document.getElementById("listaDoacoes");
    lista.innerHTML = "";

    if (querySnap.empty) {
      lista.innerHTML = "<p>Voc√™ ainda n√£o realizou nenhuma doa√ß√£o.</p>";
      return;
    }

    querySnap.forEach(docSnap => {
      const dados = docSnap.data();
      const dataDoacao = dados.dataRetirada ? new Date(dados.dataRetirada.seconds * 1000) : new Date();
      const dataFormatada = dataDoacao.toLocaleDateString('pt-BR');

      const div = document.createElement('div');
      div.classList.add('historico-item');
      div.innerHTML = `
        <p><strong>Tipo:</strong> ${dados.tipo || 'N√£o informado'}</p>
        <p><strong>Valor:</strong> ${dados.valor || 'N√£o informado'}</p>
        <p><strong>Endere√ßo:</strong> ${dados.endereco || 'N√£o informado'}</p>
        <p><strong>Data da Retirada:</strong> ${dataFormatada}</p>
      `;
      lista.appendChild(div);
    });
  }
</script>

</body>
</html>